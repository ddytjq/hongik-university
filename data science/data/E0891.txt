ID=E0891
URL=http://www.gotw.ca/gotw/063.htm
SIZE=27462
DATE=12/07/02
TIME=19:25:32
DATASET=C
HTML=
<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<meta http-equiv="Content-Language" content="en-us">


<title>GotW #63: Amok Code</title>
<meta name="GENERATOR" content="Microsoft FrontPage 4.0">
<meta name="ProgId" content="FrontPage.Editor.Document">
<link rel="stylesheet" type="text/css" href="../gotw.css">
<meta name="Microsoft Theme" content="gotw 111, default">
<meta name="Microsoft Border" content="tlb, default">
</head>

<body background="../_themes/gotw/glabkgnd.jpg" bgcolor="#CCFFFF" text="#000000" link="#008080" vlink="#008080" alink="#0000FF"  ><!--msnavigation--><table border="0" cellpadding="0" cellspacing="0" width="100%"><tr><td><!--mstheme--><font face="Arial, Arial, Helvetica"><!--mstheme--></font><table border="0" cellspacing="0" width="100%">
  <tr>
    <td colspan="2"><!--mstheme--><font face="Arial, Arial, Helvetica"><font size="6"><strong>
    GotW #63</strong></font> <!--mstheme--></font></td>
  </tr>
  <tr>
    <td valign="middle"><!--mstheme--><font face="Arial, Arial, Helvetica">




<p align="left" style="margin-top: 0; margin-bottom: 0">

<script language="JavaScript"><!--
MSFPhover = 
  (((navigator.appName == "Netscape") && 
  (parseInt(navigator.appVersion) >= 3 )) || 
  ((navigator.appName == "Microsoft Internet Explorer") && 
  (parseInt(navigator.appVersion) >= 4 ))); 
function MSFPpreload(img) 
{
  var a=new Image(); a.src=img; return a; 
}
// --></script><script language="JavaScript"><!--
if(MSFPhover) { MSFPnav1n=MSFPpreload("../_derived/home_cmp_gotw110_hbtn.gif"); MSFPnav1h=MSFPpreload("../_derived/home_cmp_gotw110_hbtn_a.gif"); }
// --></script><a href="../" language="JavaScript" onmouseover="if(MSFPhover) document['MSFPnav1'].src=MSFPnav1h.src" onmouseout="if(MSFPhover) document['MSFPnav1'].src=MSFPnav1n.src"><img src="../_derived/home_cmp_gotw110_hbtn.gif" width="140" height="40" border="0" alt="Home" align="middle" name="MSFPnav1"></a> <script language="JavaScript"><!--
if(MSFPhover) { MSFPnav2n=MSFPpreload("../_derived/news.htm_cmp_gotw110_hbtn.gif"); MSFPnav2h=MSFPpreload("../_derived/news.htm_cmp_gotw110_hbtn_a.gif"); }
// --></script><a href="../news.htm" language="JavaScript" onmouseover="if(MSFPhover) document['MSFPnav2'].src=MSFPnav2h.src" onmouseout="if(MSFPhover) document['MSFPnav2'].src=MSFPnav2n.src"><img src="../_derived/news.htm_cmp_gotw110_hbtn.gif" width="140" height="40" border="0" alt="News &amp; Events" align="middle" name="MSFPnav2"></a> <script language="JavaScript"><!--
if(MSFPhover) { MSFPnav3n=MSFPpreload("../resources/_derived/index.htm_cmp_gotw110_hbtn.gif"); MSFPnav3h=MSFPpreload("../resources/_derived/index.htm_cmp_gotw110_hbtn_a.gif"); }
// --></script><a href="../resources/index.htm" language="JavaScript" onmouseover="if(MSFPhover) document['MSFPnav3'].src=MSFPnav3h.src" onmouseout="if(MSFPhover) document['MSFPnav3'].src=MSFPnav3n.src"><img src="../resources/_derived/index.htm_cmp_gotw110_hbtn.gif" width="140" height="40" border="0" alt="Community Resources" align="middle" name="MSFPnav3"></a> <script language="JavaScript"><!--
if(MSFPhover) { MSFPnav4n=MSFPpreload("../_derived/consulting.htm_cmp_gotw110_hbtn.gif"); MSFPnav4h=MSFPpreload("../_derived/consulting.htm_cmp_gotw110_hbtn_a.gif"); }
// --></script><a href="../consulting.htm" language="JavaScript" onmouseover="if(MSFPhover) document['MSFPnav4'].src=MSFPnav4h.src" onmouseout="if(MSFPhover) document['MSFPnav4'].src=MSFPnav4n.src"><img src="../_derived/consulting.htm_cmp_gotw110_hbtn.gif" width="140" height="40" border="0" alt="Consulting Services" align="middle" name="MSFPnav4"></a> <script language="JavaScript"><!--
if(MSFPhover) { MSFPnav5n=MSFPpreload("../_derived/presentations.htm_cmp_gotw110_hbtn.gif"); MSFPnav5h=MSFPpreload("../_derived/presentations.htm_cmp_gotw110_hbtn_a.gif"); }
// --></script><a href="../presentations.htm" language="JavaScript" onmouseover="if(MSFPhover) document['MSFPnav5'].src=MSFPnav5h.src" onmouseout="if(MSFPhover) document['MSFPnav5'].src=MSFPnav5n.src"><img src="../_derived/presentations.htm_cmp_gotw110_hbtn.gif" width="140" height="40" border="0" alt="Presentations" align="middle" name="MSFPnav5"></a> <script language="JavaScript"><!--
if(MSFPhover) { MSFPnav6n=MSFPpreload("../publications/_derived/index.htm_cmp_gotw110_hbtn.gif"); MSFPnav6h=MSFPpreload("../publications/_derived/index.htm_cmp_gotw110_hbtn_a.gif"); }
// --></script><a href="../publications/index.htm" language="JavaScript" onmouseover="if(MSFPhover) document['MSFPnav6'].src=MSFPnav6h.src" onmouseout="if(MSFPhover) document['MSFPnav6'].src=MSFPnav6n.src"><img src="../publications/_derived/index.htm_cmp_gotw110_hbtn.gif" width="140" height="40" border="0" alt="Publications" align="middle" name="MSFPnav6"></a> <script language="JavaScript"><!--
if(MSFPhover) { MSFPnav7n=MSFPpreload("_derived/index.htm_cmp_gotw110_hbtn.gif"); MSFPnav7h=MSFPpreload("_derived/index.htm_cmp_gotw110_hbtn_a.gif"); }
// --></script><a href="index.htm" language="JavaScript" onmouseover="if(MSFPhover) document['MSFPnav7'].src=MSFPnav7h.src" onmouseout="if(MSFPhover) document['MSFPnav7'].src=MSFPnav7n.src"><img src="_derived/index.htm_cmp_gotw110_hbtn.gif" width="140" height="40" border="0" alt="Guru of the Week" align="middle" name="MSFPnav7"></a> <script language="JavaScript"><!--
if(MSFPhover) { MSFPnav8n=MSFPpreload("../conv/_derived/index.htm_cmp_gotw110_hbtn.gif"); MSFPnav8h=MSFPpreload("../conv/_derived/index.htm_cmp_gotw110_hbtn_a.gif"); }
// --></script><a href="../conv/index.htm" language="JavaScript" onmouseover="if(MSFPhover) document['MSFPnav8'].src=MSFPnav8h.src" onmouseout="if(MSFPhover) document['MSFPnav8'].src=MSFPnav8n.src"><img src="../conv/_derived/index.htm_cmp_gotw110_hbtn.gif" width="140" height="40" border="0" alt="Conversations" align="middle" name="MSFPnav8"></a> <script language="JavaScript"><!--
if(MSFPhover) { MSFPnav9n=MSFPpreload("../_derived/search.htm_cmp_gotw110_hbtn.gif"); MSFPnav9h=MSFPpreload("../_derived/search.htm_cmp_gotw110_hbtn_a.gif"); }
// --></script><a href="../search.htm" language="JavaScript" onmouseover="if(MSFPhover) document['MSFPnav9'].src=MSFPnav9h.src" onmouseout="if(MSFPhover) document['MSFPnav9'].src=MSFPnav9n.src"><img src="../_derived/search.htm_cmp_gotw110_hbtn.gif" width="140" height="40" border="0" alt="Search GotW.ca" align="middle" name="MSFPnav9"></a>
</p>




    <!--mstheme--></font></td>
    <td valign="middle"><!--mstheme--><font face="Arial, Arial, Helvetica">
      <p style="margin-top: 0; margin-bottom: 0">
      <script language="JavaScript"><!--
if(MSFPhover) { MSFPnav10n=MSFPpreload("../_derived/back_cmp_gotw110_back.gif"); MSFPnav10h=MSFPpreload("../_derived/back_cmp_gotw110_back_a.gif"); }
// --></script><a href="062.htm" language="JavaScript" onmouseover="if(MSFPhover) document['MSFPnav10'].src=MSFPnav10h.src" onmouseout="if(MSFPhover) document['MSFPnav10'].src=MSFPnav10n.src"><img src="../_derived/back_cmp_gotw110_back.gif" width="100" height="20" border="0" alt="Prev" name="MSFPnav10"></a><br><script language="JavaScript"><!--
if(MSFPhover) { MSFPnav11n=MSFPpreload("../_derived/up_cmp_gotw110_up.gif"); MSFPnav11h=MSFPpreload("../_derived/up_cmp_gotw110_up_a.gif"); }
// --></script><a href="index.htm" language="JavaScript" onmouseover="if(MSFPhover) document['MSFPnav11'].src=MSFPnav11h.src" onmouseout="if(MSFPhover) document['MSFPnav11'].src=MSFPnav11n.src"><img src="../_derived/up_cmp_gotw110_up.gif" width="100" height="20" border="0" alt="Up" name="MSFPnav11"></a><br><script language="JavaScript"><!--
if(MSFPhover) { MSFPnav12n=MSFPpreload("../_derived/next_cmp_gotw110_next.gif"); MSFPnav12h=MSFPpreload("../_derived/next_cmp_gotw110_next_a.gif"); }
// --></script><a href="064.htm" language="JavaScript" onmouseover="if(MSFPhover) document['MSFPnav12'].src=MSFPnav12h.src" onmouseout="if(MSFPhover) document['MSFPnav12'].src=MSFPnav12n.src"><img src="../_derived/next_cmp_gotw110_next.gif" width="100" height="20" border="0" alt="Next" name="MSFPnav12"></a><!--mstheme--></font></td>
  </tr>
  <tr>
    <td height="5" background="../images/bar.gif" colspan="2"><!--mstheme--><font face="Arial, Arial, Helvetica">&nbsp;<!--mstheme--></font></td>
  </tr>
</table><!--mstheme--><font face="Arial, Arial, Helvetica"><!--mstheme--></font></td></tr><!--msnavigation--></table><!--msnavigation--><table dir="ltr" border="0" cellpadding="0" cellspacing="0" width="100%"><tr><td valign="top" width="1%"><!--mstheme--><font face="Arial, Arial, Helvetica">

<!--mstheme--></font><table border="0" cellspacing="0" bgcolor="#000000" cellpadding="0">
  <tr>
    <td><!--mstheme--><font face="Arial, Arial, Helvetica">
    <!--mstheme--></font><table border="0" cellpadding="2" cellspacing="1" width="100%" height="483">
        <tr>
          <td align="center" bgcolor="#000000" colspan="2" height="16"><!--mstheme--><font face="Arial, Arial, Helvetica">
            <p style="margin-top: 0; margin-bottom: 0"><a href="../news.htm"><b><font color="#FFFF00">News</font></b></a><!--mstheme--></font></td>
        </tr>
        <tr>
          <td align="center" bgcolor="#CCCCCC" bordercolor="#CCCCCC" rowspan="3"><!--mstheme--><font face="Arial, Arial, Helvetica">
          <font size="1" color="#0000FF">J<br>
          U<br>
          L<br>
          Y</font><!--mstheme--></font></td>
          <td align="left" bgcolor="#FFFF99" bordercolor="#CCCCCC"><!--mstheme--><font face="Arial, Arial, Helvetica">
            <p style="margin-left: 3; margin-right: 3; margin-top: 0" align="center"><font size="1" color="#0000FF">
            Print articles newly available online</font><!--mstheme--></font><table border="1" cellpadding="0" cellspacing="0" style="border-collapse: collapse" bordercolor="#111111" width="100%" id="AutoNumber1" bgcolor="#FFFFCC" bordercolordark="#006666" bordercolorlight="#99CCCC">
              <tr>
                <td width="100%" bordercolor="#808000"><!--mstheme--><font face="Arial, Arial, Helvetica">
                <p style="margin: 3"><font size="1" color="#0000FF">
                <a href="../publications/mill20.htm"><b><i>
                <font color="#0000FF">Sutter's Mill</font></i></b><font color="#0000FF"> 
                column, &quot;Toward a Standard C++ Library, Part 1&quot;</font></a></font><!--mstheme--></font></td>
              </tr>
              <tr>
                <td width="100%" bordercolor="#808000" bgcolor="#FFFFCC"><!--mstheme--><font face="Arial, Arial, Helvetica">
                <p style="margin: 3"><font size="1" color="#0000FF">
                <a href="../publications/mxc++-item-4.htm">
                <font color="#0000FF">Excerpt from MXC++, &quot;Extensible Templates: 
                Via Inheritance or Traits?&quot;</font></a></font><!--mstheme--></font></td>
              </tr>
              <tr>
                <td width="100%" bordercolor="#808000"><!--mstheme--><font face="Arial, Arial, Helvetica">
                <p style="margin: 3"><font size="1" color="#0000FF">
                <a href="../publications/mcd_review.htm"><font color="#0000FF">
                Book Review: Modern C++ Design</font></a></font><!--mstheme--></font></td>
              </tr>
              <tr>
                <td width="100%" bordercolor="#808000"><!--mstheme--><font face="Arial, Arial, Helvetica">
                <p style="margin: 3"><font size="1" color="#0000FF">
                <a href="../publications/mill21.htm"><b><i>
                <font color="#0000FF">Sutter's Mill</font></i></b><font color="#0000FF"> 
                column, &quot;Toward a Standard C++ Library, Part 2: Namespaceops and 
                Library Versioning&quot;</font></a></font><!--mstheme--></font></td>
              </tr>
            </table><!--mstheme--><font face="Arial, Arial, Helvetica">
          <!--mstheme--></font></td>
        </tr>
        <tr>
          <td align="left" bgcolor="#FFFF99" bordercolor="#CCCCCC"><!--mstheme--><font face="Arial, Arial, Helvetica">
            <p style="margin: 0 3"><font size="1" color="#0000FF"><b><i>Sutter's 
            Mill</i></b> column,
            &quot;A Pragmatic Look at Exception Specifications&quot;<br>
            </font><font size="1" color="#000080">The usefulness, or lack 
            thereof, of exception specifications, and how results can vary 
            across real-world compilers</font><!--mstheme--></font></td>
        </tr>
        <tr>
          <td align="left" bgcolor="#FFFF99" bordercolor="#CCCCCC"><!--mstheme--><font face="Arial, Arial, Helvetica">
            <p style="margin: 0 3">
            <a target="_blank" href="http://www.cuj.com/experts/2007/hyslop.htm"><font size="1" color="#0000FF"><i><b>Conversations</b></i> column,
            &quot;Getting to the Point&quot;</font></a><font color="#0000FF" size="1"><br>
            </font><font size="1" color="#000080">The Boost library has five 
            smart pointers that provide a rich array [sic] of useful behaviors.</font><!--mstheme--></font></td>
        </tr>
        <tr>
          <td align="center" bgcolor="#CCCCCC" bordercolor="#CCCCCC" rowspan="2"><!--mstheme--><font face="Arial, Arial, Helvetica"><font color="#0000FF" size="1">A<br>
            U<br>
          G<br>
          U<br>
          S<br>
          T</font><!--mstheme--></font></td>
          <td align="left" bgcolor="#FFFF99" bordercolor="#CCCCCC"><!--mstheme--><font face="Arial, Arial, Helvetica">
            <p style="margin:0 3; ">
            <a target="_blank" href="http://www.cuj.com/experts/2008/sutter.htm"><i><b><font size="1" color="#0000FF">The New C++</font></b></i> <font size="1" color="#0000FF">
            column, &quot;Smart(er) Pointers&quot;</font></a><font size="1" color="#000080"><br>
            A closer look at one of the proposed new standard C++ library 
            features -- smart pointers, particularly those in Boost and Loki, 
            and a sneak peek at the usefulness of the proposed typedef templates</font><!--mstheme--></font></td>
        </tr>
        <tr>
          <td align="left" bgcolor="#FFFF99" bordercolor="#CCCCCC"><!--mstheme--><font face="Arial, Arial, Helvetica">
          <p style="margin:0 3; ">
          <a target="_blank" href="http://www.cuj.com/experts/2008/hyslop.htm"><font size="1" color="#0000FF"><i><b>Conversations</b></i> column,
            &quot;A Midsummer Night's Madness&quot;</font></a><font color="#0000FF" size="1"><br>
            </font><font size="1" color="#000080">A brew that mixes pointers, 
          typedefs, and const</font><!--mstheme--></font></td>
        </tr>
        <tr>
          <td align="center" bgcolor="#CCCCCC" bordercolor="#CCCCCC" rowspan="3"><!--mstheme--><font face="Arial, Arial, Helvetica">
          <p style="margin-top: 0; margin-bottom: 0">
          <font size="1" color="#0000FF">S<br>
          E<br>
          P<br>
          T<br>
          E<br>
          M<br>
          B<br>
          E<br>
          R</font><!--mstheme--></font></td>
        </tr>
        <tr>
          <td align="left" bgcolor="#FFFF99" bordercolor="#CCCCCC"><!--mstheme--><font face="Arial, Arial, Helvetica">
            <p style="margin: 0 3">
            <font size="1" color="#0000FF">&quot;Standard C++ Meets Managed C++&quot;<br>
            </font><font size="1" color="#000080">A survey of the main (in)compatibilities 
            between Standard C++ and Microsoft’s managed extensions for C++, and 
            how the two could converge</font><!--mstheme--></font></td>
        </tr>
        <tr>
          <td align="left" bgcolor="#FFFF99" bordercolor="#CCCCCC"><!--mstheme--><font face="Arial, Arial, Helvetica">
            <p style="margin: 0 3"><font size="1" color="#0000FF"><b><i>Sutter's 
            Mill</i></b> column,
            &quot;Export Restrictions, Part 1&quot;<br>
            </font><font size="1" color="#000080">The scoop on export -- what 
            some people think it does, what it actually does, and why it’s the 
            most widely-ignored feature in the C++ standard</font><!--mstheme--></font></td>
        </tr>
      </table><!--mstheme--><font face="Arial, Arial, Helvetica"><!--mstheme--></font></td>
  </tr>
</table><!--mstheme--><font face="Arial, Arial, Helvetica">
<p style="margin-top: 0; margin-bottom: 0">
<img border="0" src="../images/140.gif" width="140" height="1"></p>

<!--mstheme--></font></td><td valign="top" width="24"></td><!--msnavigation--><td valign="top"><!--mstheme--><font face="Arial, Arial, Helvetica">
      <h2><!--mstheme--><font face="Verdana, Arial, Helvetica" color="#006666">Amok Code&nbsp;<font size="3"><br>
      Difficulty: 4 / 10</font><!--mstheme--></font></h2>
<p><i>Sometimes life hands you some debugging situations that seem just plain
deeply weird. Try this one on for size, and see if you can reason about possible
causes for the problem.</i></p>
<p align="center"><img border="0" src="../images/h-line.gif" width="248" height="2"></p>

<h3><!--mstheme--><font face="Verdana, Arial, Helvetica" color="#006666">Problem<!--mstheme--></font></h3>

<p><b><font size="4">1.</font></b>   One programmer has written the following
code:</p>
<blockquote>
  <p><font face="Courier New">//--- file biology.h<br>
  //</font></p>
  <p><font face="Courier New">// ... appropriate includes and other stuff ...</font></p>
  <p><font face="Courier New">class Animal<br>
  {<br>
  public:<br>
  &nbsp; // Functions that operate on this object:<br>
  &nbsp; //<br>
  &nbsp; virtual int Eat&nbsp;&nbsp;&nbsp; ( int ) { /*...*/ }<br>
  &nbsp; virtual int Excrete( int ) { /*...*/ }<br>
  &nbsp; virtual int Sleep&nbsp; ( int ) { /*...*/ }<br>
  &nbsp; virtual int Wake&nbsp;&nbsp; ( int ) { /*...*/ }<br>
  <br>
  &nbsp; // For animals that were once married, and<br>
  &nbsp; // sometimes dislike their ex-spouses, we provide:<br>
  &nbsp; //<br>
  &nbsp; int EatEx&nbsp;&nbsp;&nbsp; ( Animal* a ) { /*...*/ };<br>
  &nbsp; int ExcreteEx( Animal* a ) { /*...*/ };<br>
  &nbsp; int SleepEx&nbsp; ( Animal* a ) { /*...*/ };<br>
  &nbsp; int WakeEx&nbsp;&nbsp; ( Animal* a ) { /*...*/ };<br>
  <br>
  &nbsp; // ...<br>
  };<br>
  <br>
  // Concrete classes.<br>
  //<br>
  class Cat&nbsp;&nbsp;&nbsp; : public Animal { /*...*/ };<br>
  class Dog&nbsp;&nbsp;&nbsp; : public Animal { /*...*/ };<br>
  class Weevil : public Animal { /*...*/ };<br>
  // ... more cute critters ...<br>
  <br>
  // Convenient, if redundant, helper functions.<br>
  //<br>
  int Eat&nbsp;&nbsp;&nbsp; ( Animal* a ) { return a-&gt;Eat( 1
  );&nbsp;&nbsp;&nbsp;&nbsp; }<br>
  int Excrete( Animal* a ) { return a-&gt;Excrete( 1 ); }<br>
  int Sleep&nbsp; ( Animal* a ) { return a-&gt;Sleep( 1 );&nbsp;&nbsp; }<br>
  int Wake&nbsp;&nbsp; ( Animal* a ) { return a-&gt;Wake( 1 );&nbsp;&nbsp;&nbsp;
  }</font></p>
</blockquote>
<p>Unfortunately, the code fails to compile. The compiler rejects the definition
of at least one of the ...Ex() functions with an error message saying the
function has already been defined.</p>
<p>To get around the compile error, the programmer comments out the ...Ex()
functions, and now the program compiles and he starts testing the sleeping
functions. Unfortunately, the Animal::Sleep() member function doesn't seem to
always work correctly; when he tries to call the member function Animal::Sleep()
directly, all is well. But when he tries to call it through the Sleep() free
function wrapper, which does nothing but call the member function version,
sometimes nothing happens... not all the time, only in some cases. Finally, when
the programmer goes into the debugger or the linker- generated symbol map in an
attempt to diagnose the problem, he can't seem to even find the code for
Animal::Sleep() at all.</p>
<p>Is the compiler on the fritz? Should the programmer send the compiler vendor
an angry flame e-mail and submit an irate letter to the New York Times? Is it a
Year 2000 problem? Or is it just due to a rogue virus caught from the Internet?</p>
<p>What's going on?</p>
<p align="center"><img border="0" src="../images/h-line.gif" width="248" height="2"></p>
<h3><!--mstheme--><font face="Verdana, Arial, Helvetica" color="#006666"><a name="Solution"></a>Solution<!--mstheme--></font></h3>

<p><font color="#999933"><b><font size="4">1.</font></b>   One programmer has
written the following code:</font></p>
<p>[...]</p>
<p><font color="#999933">What's going on?</font></p>
<p>In short, there are several things that might be going on to cause these
symptoms, but there's one outstanding possibility that would account for all of
the observed behavior: Yes, you guessed it, an ugly combination of macros
running amok and a side dish of mixed intentional and unintentional overloading.</p>
<h4><!--mstheme--><font face="Verdana, Arial, Helvetica" color="#006666">Motivation<!--mstheme--></font></h4>
<p>Certain popular C++ programming environments give you macros that are
deliberately designed to change function names. Usually they do this for
&quot;good&quot; or &quot;innocent&quot; reasons, namely backward and forward
API compatibility; for example, if a Sleep() function in one version of an
operating system is replaced by a SleepEx(), the vendor supplying the header in
which the functions are declared might decide to &quot;helpfully&quot; provide a
macro that automatically changes Sleep to SleepEx.</p>
<p>This is not a good idea. Macros are the antithesis of encapsulation, because
their actual range of effect cannot be controlled, not even by the macro writer.</p>
<h4><!--mstheme--><font face="Verdana, Arial, Helvetica" color="#006666">Macros Don't Care<!--mstheme--></font></h4>
<p>Macros are obnoxious, smelly, sheet-hogging bedfellows for several reasons,
most of which are related to the fact that they are a glorified
text-substitution facility whose effects are applied during preprocessing,
before any C++ syntax and semantic rules can even begin to apply. The following
are some of macros' less charming habits.</p>
<p>1. Macros change names -- more often than not to harm, <i>not</i> protect, the
innocent.</p>
<p>It is an understatement to say that this silent renaming can make debugging
somewhat confusing. Such macro renaming means that your functions aren't
actually called what you think they're called.</p>
<p>For example, consider our nonmember function Sleep():</p>
<blockquote>

<p><font face="Courier New" color="#999933">int Sleep&nbsp; ( Animal* a ) {
return a-&gt;Sleep( 1 );&nbsp;&nbsp; }</font></p>

</blockquote>
<p>You won't find Sleep() anywhere in the object code or the linker map file
because there's really no Sleep() function at all. It's really called SleepEx().
At first, when you're wondering where your Sleep() went, you might think,
&quot;ah, maybe the compiler is automatically inlining Sleep() for me,&quot;
because that would explain why the short function doesn't seem to exist --
although of course the compiler shouldn't be inlining things without first being
so directed. If you jump to conclusions and fire off an angry email to your
compiler vendor complaining about aggressive optimizations, though, you're
blaming the wrong company (or, at least, the wrong department).</p>
<p>Some of you may already have encountered this unfortunate and demonstrably
bad effect. If you're like me, which is to say easily irritated by compiler
weirdnesses and not satisfied with simple explanations, your curiosity bump
might get the better of you. Then, curious, you may fire up the debugger and
deliberately step into the function... only to be taken to the correct source
line where the phantom function (which still looks like it has its original
name, in the source code) lives, stepping into the phantom function that indeed
works and is indeed getting called, but which by all other accounts doesn't seem
to exist. Usually at this point it's a short step to figuring out what's really
going on and a sotto voce grumbling at stupid macro tricks.</p>
<p>But wait, it gets better:</p>
<p>1(b). C++ already has features to deal with names. This causes what might be
best termed an &quot;unhealthy interaction.&quot;</p>
<p>You might think that it's not such a big deal to change a function's name.
All right, fine, often it's not. But say you change a function's name to be the
same as another function that also exists... what does C++ do if it finds two
functions with the same name? It overloads them. That's not quite so fine when
you don't realize it's happening silently.</p>
<p>This, alas, seems to be the case with Sleep(). The whole reason the library
vendor decided to &quot;helpfully&quot; provide a Sleep macro to automatically
rename things to SleepEx is because both such functions in fact do already exist
in the vendor's library. Consider that the functions may have different
signatures; then when we write our own Sleep() function, we might well be aware
of the overloading on the library-supplied Sleep() and take care to avoid
ambiguities or other errors that might cause us problems. We might even rely on
the overloading because we want to provide library-Sleep()-like behavior
intentionally. If, instead, our function is getting silently overloaded with
some other function, not only is the overload going to behave differently than
we expect, but if our original overloading was intentional it's not going to
happen at all, at least not in the way we thought.</p>
<p>In the context of our question, such a Sleep-renaming macro can partly
explain why different functions could end up being called in different
circumstances; which function gets called can depend on how the overload
resolution happened to work out for the specific types used at different call
sites. Sometimes it's ours, and sometimes it's the library's. It just depends,
perhaps in nonobvious ways.</p>
<p>If this sordid tale ended with the above lamentable effects on nonmember
functions, that would be bad enough. Unfortunately, like shrapnel from a
grenade, there's dangerous stuff flying in several other directions too:</p>
<p>2. Macros don't care about type.</p>
<p>The original intent for the Sleep macro described above was to change a
global nonmember function's name. Unfortunately, the macro will change the name
Sleep wherever it finds it; if we happen to have a global variable named Sleep,
that member's name will silently change too. This is altogether a bad thing.</p>
<p>3. Macros don't care about scope.</p>
<p>Worse still, a macro designed to change a global nonmember function name will
happily change any matching function (or other) names that happen to be members
of your classes or nicely encapsulated within your own namespaces. In this case,
we wrote a class with both Sleep() and SleepEx() functions; many of the
described problems could be accounted for at least in part by a Sleep-renaming
macro that makes our own functions invisibly overload -- with each other.
Indeed, as with the invisible overloading mentioned above under point #1, this
can explain why sometimes an unexpected member function can be called, depending
on how the overload resolution happened to work out for the specific types used
at different call sites.</p>
<p>If you think this is a Bad Thing, you're right. It's like having some
ungloved uncertified doctor (the injudicious library header writer) with dirty
hands (unsterilized macros) slice open your torso (class or namespace) and reach
into your body cavity to rearrange things (members and other code)... while
sleepwalking (not even realizing they're doing it).</p>
<h4><!--mstheme--><font face="Verdana, Arial, Helvetica" color="#006666">Summary<!--mstheme--></font></h4>
<p>In short, macros don't care about much of anything.</p>
<blockquote>
  <p><b>Guideline:</b> Avoid macros.</p>
</blockquote>
<p>Your default response to macros should be something like &quot;Macros! Ew,
yuck!&quot; unless there's a compelling reason to use them in special cases
where they are not a hack. Macros are not type-safe, they're not scope-safe...
they're just not safe, period. If you must write macros, avoid putting them in
header files, and try to give them long and personalized names that are highly
unlikely to ever tromp upon things that they aren't intentionally meant to beat
into unwilling submission and grind under their heels into the dust.</p>
<blockquote>
  <p><b>Guideline:</b> Prefer to use namespaces.</p>
</blockquote>
<p>True, as noted above, macros don't respect scope, and that includes namespace
scope. However, had the free functions in the question been put inside a
namespace, it would have prevented at least some of the problems; specifically,
it would have avoided the global overloading with the vendor-supplied functions.</p>
<p>In short, practice good encapsulation. Not only does good encapsulation make
for better designs, but it can defend you against unexpected threats you might
not even see coming. Macros are the antithesis of encapsulation, because their
actual range of effect cannot be controlled, not even by the macro writer.
Classes and namespaces are among C++'s useful tools to help manage and minimize
interdependencies between parts of your program that should be unrelated, and
judicious use of these and other C++ facilities to promote encapsulation will
not just make for superior designs, but will at the same time offer a measure of
protection against the shrapnel that ill-considered code from fellow
programmers, however well-intentioned, might occasionally send your way.<!--mstheme--></font><!--msnavigation--></td></tr><!--msnavigation--></table><!--msnavigation--><table border="0" cellpadding="0" cellspacing="0" width="100%"><tr><td><!--mstheme--><font face="Arial, Arial, Helvetica"><h4 align="right"><!--mstheme--><font face="Verdana, Arial, Helvetica" color="#006666"><a href="../copyright.htm"><font size="2">Copyright ©
2002 Herb Sutter</font></a><!--mstheme--></font></h4>

<!--mstheme--></font></td></tr><!--msnavigation--></table></body>
</html>

