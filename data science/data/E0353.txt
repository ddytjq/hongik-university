ID=E0353
URL=http://www.gotw.ca/gotw/053.htm
SIZE=37146
DATE=12/07/02
TIME=19:20:09
DATASET=C
HTML=
<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1252">
<meta http-equiv="Content-Language" content="en-us">


<title>GotW #53: Migrating to Namespaces</title>
<meta name="GENERATOR" content="Microsoft FrontPage 4.0">
<meta name="ProgId" content="FrontPage.Editor.Document">
<link rel="stylesheet" type="text/css" href="../gotw.css">
<meta name="Microsoft Theme" content="gotw 111, default">
<meta name="Microsoft Border" content="tlb, default">
</head>

<body background="../_themes/gotw/glabkgnd.jpg" bgcolor="#CCFFFF" text="#000000" link="#008080" vlink="#008080" alink="#0000FF"  ><!--msnavigation--><table border="0" cellpadding="0" cellspacing="0" width="100%"><tr><td><!--mstheme--><font face="Arial, Arial, Helvetica"><!--mstheme--></font><table border="0" cellspacing="0" width="100%">
  <tr>
    <td colspan="2"><!--mstheme--><font face="Arial, Arial, Helvetica"><font size="6"><strong>
    GotW #53</strong></font> <!--mstheme--></font></td>
  </tr>
  <tr>
    <td valign="middle"><!--mstheme--><font face="Arial, Arial, Helvetica">




<p align="left" style="margin-top: 0; margin-bottom: 0">

<script language="JavaScript"><!--
MSFPhover = 
  (((navigator.appName == "Netscape") && 
  (parseInt(navigator.appVersion) >= 3 )) || 
  ((navigator.appName == "Microsoft Internet Explorer") && 
  (parseInt(navigator.appVersion) >= 4 ))); 
function MSFPpreload(img) 
{
  var a=new Image(); a.src=img; return a; 
}
// --></script><script language="JavaScript"><!--
if(MSFPhover) { MSFPnav1n=MSFPpreload("../_derived/home_cmp_gotw110_hbtn.gif"); MSFPnav1h=MSFPpreload("../_derived/home_cmp_gotw110_hbtn_a.gif"); }
// --></script><a href="../" language="JavaScript" onmouseover="if(MSFPhover) document['MSFPnav1'].src=MSFPnav1h.src" onmouseout="if(MSFPhover) document['MSFPnav1'].src=MSFPnav1n.src"><img src="../_derived/home_cmp_gotw110_hbtn.gif" width="140" height="40" border="0" alt="Home" align="middle" name="MSFPnav1"></a> <script language="JavaScript"><!--
if(MSFPhover) { MSFPnav2n=MSFPpreload("../_derived/news.htm_cmp_gotw110_hbtn.gif"); MSFPnav2h=MSFPpreload("../_derived/news.htm_cmp_gotw110_hbtn_a.gif"); }
// --></script><a href="../news.htm" language="JavaScript" onmouseover="if(MSFPhover) document['MSFPnav2'].src=MSFPnav2h.src" onmouseout="if(MSFPhover) document['MSFPnav2'].src=MSFPnav2n.src"><img src="../_derived/news.htm_cmp_gotw110_hbtn.gif" width="140" height="40" border="0" alt="News &amp; Events" align="middle" name="MSFPnav2"></a> <script language="JavaScript"><!--
if(MSFPhover) { MSFPnav3n=MSFPpreload("../resources/_derived/index.htm_cmp_gotw110_hbtn.gif"); MSFPnav3h=MSFPpreload("../resources/_derived/index.htm_cmp_gotw110_hbtn_a.gif"); }
// --></script><a href="../resources/index.htm" language="JavaScript" onmouseover="if(MSFPhover) document['MSFPnav3'].src=MSFPnav3h.src" onmouseout="if(MSFPhover) document['MSFPnav3'].src=MSFPnav3n.src"><img src="../resources/_derived/index.htm_cmp_gotw110_hbtn.gif" width="140" height="40" border="0" alt="Community Resources" align="middle" name="MSFPnav3"></a> <script language="JavaScript"><!--
if(MSFPhover) { MSFPnav4n=MSFPpreload("../_derived/consulting.htm_cmp_gotw110_hbtn.gif"); MSFPnav4h=MSFPpreload("../_derived/consulting.htm_cmp_gotw110_hbtn_a.gif"); }
// --></script><a href="../consulting.htm" language="JavaScript" onmouseover="if(MSFPhover) document['MSFPnav4'].src=MSFPnav4h.src" onmouseout="if(MSFPhover) document['MSFPnav4'].src=MSFPnav4n.src"><img src="../_derived/consulting.htm_cmp_gotw110_hbtn.gif" width="140" height="40" border="0" alt="Consulting Services" align="middle" name="MSFPnav4"></a> <script language="JavaScript"><!--
if(MSFPhover) { MSFPnav5n=MSFPpreload("../_derived/presentations.htm_cmp_gotw110_hbtn.gif"); MSFPnav5h=MSFPpreload("../_derived/presentations.htm_cmp_gotw110_hbtn_a.gif"); }
// --></script><a href="../presentations.htm" language="JavaScript" onmouseover="if(MSFPhover) document['MSFPnav5'].src=MSFPnav5h.src" onmouseout="if(MSFPhover) document['MSFPnav5'].src=MSFPnav5n.src"><img src="../_derived/presentations.htm_cmp_gotw110_hbtn.gif" width="140" height="40" border="0" alt="Presentations" align="middle" name="MSFPnav5"></a> <script language="JavaScript"><!--
if(MSFPhover) { MSFPnav6n=MSFPpreload("../publications/_derived/index.htm_cmp_gotw110_hbtn.gif"); MSFPnav6h=MSFPpreload("../publications/_derived/index.htm_cmp_gotw110_hbtn_a.gif"); }
// --></script><a href="../publications/index.htm" language="JavaScript" onmouseover="if(MSFPhover) document['MSFPnav6'].src=MSFPnav6h.src" onmouseout="if(MSFPhover) document['MSFPnav6'].src=MSFPnav6n.src"><img src="../publications/_derived/index.htm_cmp_gotw110_hbtn.gif" width="140" height="40" border="0" alt="Publications" align="middle" name="MSFPnav6"></a> <script language="JavaScript"><!--
if(MSFPhover) { MSFPnav7n=MSFPpreload("_derived/index.htm_cmp_gotw110_hbtn.gif"); MSFPnav7h=MSFPpreload("_derived/index.htm_cmp_gotw110_hbtn_a.gif"); }
// --></script><a href="index.htm" language="JavaScript" onmouseover="if(MSFPhover) document['MSFPnav7'].src=MSFPnav7h.src" onmouseout="if(MSFPhover) document['MSFPnav7'].src=MSFPnav7n.src"><img src="_derived/index.htm_cmp_gotw110_hbtn.gif" width="140" height="40" border="0" alt="Guru of the Week" align="middle" name="MSFPnav7"></a> <script language="JavaScript"><!--
if(MSFPhover) { MSFPnav8n=MSFPpreload("../conv/_derived/index.htm_cmp_gotw110_hbtn.gif"); MSFPnav8h=MSFPpreload("../conv/_derived/index.htm_cmp_gotw110_hbtn_a.gif"); }
// --></script><a href="../conv/index.htm" language="JavaScript" onmouseover="if(MSFPhover) document['MSFPnav8'].src=MSFPnav8h.src" onmouseout="if(MSFPhover) document['MSFPnav8'].src=MSFPnav8n.src"><img src="../conv/_derived/index.htm_cmp_gotw110_hbtn.gif" width="140" height="40" border="0" alt="Conversations" align="middle" name="MSFPnav8"></a> <script language="JavaScript"><!--
if(MSFPhover) { MSFPnav9n=MSFPpreload("../_derived/search.htm_cmp_gotw110_hbtn.gif"); MSFPnav9h=MSFPpreload("../_derived/search.htm_cmp_gotw110_hbtn_a.gif"); }
// --></script><a href="../search.htm" language="JavaScript" onmouseover="if(MSFPhover) document['MSFPnav9'].src=MSFPnav9h.src" onmouseout="if(MSFPhover) document['MSFPnav9'].src=MSFPnav9n.src"><img src="../_derived/search.htm_cmp_gotw110_hbtn.gif" width="140" height="40" border="0" alt="Search GotW.ca" align="middle" name="MSFPnav9"></a>
</p>




    <!--mstheme--></font></td>
    <td valign="middle"><!--mstheme--><font face="Arial, Arial, Helvetica">
      <p style="margin-top: 0; margin-bottom: 0">
      <script language="JavaScript"><!--
if(MSFPhover) { MSFPnav10n=MSFPpreload("../_derived/back_cmp_gotw110_back.gif"); MSFPnav10h=MSFPpreload("../_derived/back_cmp_gotw110_back_a.gif"); }
// --></script><a href="052.htm" language="JavaScript" onmouseover="if(MSFPhover) document['MSFPnav10'].src=MSFPnav10h.src" onmouseout="if(MSFPhover) document['MSFPnav10'].src=MSFPnav10n.src"><img src="../_derived/back_cmp_gotw110_back.gif" width="100" height="20" border="0" alt="Prev" name="MSFPnav10"></a><br><script language="JavaScript"><!--
if(MSFPhover) { MSFPnav11n=MSFPpreload("../_derived/up_cmp_gotw110_up.gif"); MSFPnav11h=MSFPpreload("../_derived/up_cmp_gotw110_up_a.gif"); }
// --></script><a href="index.htm" language="JavaScript" onmouseover="if(MSFPhover) document['MSFPnav11'].src=MSFPnav11h.src" onmouseout="if(MSFPhover) document['MSFPnav11'].src=MSFPnav11n.src"><img src="../_derived/up_cmp_gotw110_up.gif" width="100" height="20" border="0" alt="Up" name="MSFPnav11"></a><br><script language="JavaScript"><!--
if(MSFPhover) { MSFPnav12n=MSFPpreload("../_derived/next_cmp_gotw110_next.gif"); MSFPnav12h=MSFPpreload("../_derived/next_cmp_gotw110_next_a.gif"); }
// --></script><a href="054.htm" language="JavaScript" onmouseover="if(MSFPhover) document['MSFPnav12'].src=MSFPnav12h.src" onmouseout="if(MSFPhover) document['MSFPnav12'].src=MSFPnav12n.src"><img src="../_derived/next_cmp_gotw110_next.gif" width="100" height="20" border="0" alt="Next" name="MSFPnav12"></a><!--mstheme--></font></td>
  </tr>
  <tr>
    <td height="5" background="../images/bar.gif" colspan="2"><!--mstheme--><font face="Arial, Arial, Helvetica">&nbsp;<!--mstheme--></font></td>
  </tr>
</table><!--mstheme--><font face="Arial, Arial, Helvetica"><!--mstheme--></font></td></tr><!--msnavigation--></table><!--msnavigation--><table dir="ltr" border="0" cellpadding="0" cellspacing="0" width="100%"><tr><td valign="top" width="1%"><!--mstheme--><font face="Arial, Arial, Helvetica">

<!--mstheme--></font><table border="0" cellspacing="0" bgcolor="#000000" cellpadding="0">
  <tr>
    <td><!--mstheme--><font face="Arial, Arial, Helvetica">
    <!--mstheme--></font><table border="0" cellpadding="2" cellspacing="1" width="100%" height="483">
        <tr>
          <td align="center" bgcolor="#000000" colspan="2" height="16"><!--mstheme--><font face="Arial, Arial, Helvetica">
            <p style="margin-top: 0; margin-bottom: 0"><a href="../news.htm"><b><font color="#FFFF00">News</font></b></a><!--mstheme--></font></td>
        </tr>
        <tr>
          <td align="center" bgcolor="#CCCCCC" bordercolor="#CCCCCC" rowspan="3"><!--mstheme--><font face="Arial, Arial, Helvetica">
          <font size="1" color="#0000FF">J<br>
          U<br>
          L<br>
          Y</font><!--mstheme--></font></td>
          <td align="left" bgcolor="#FFFF99" bordercolor="#CCCCCC"><!--mstheme--><font face="Arial, Arial, Helvetica">
            <p style="margin-left: 3; margin-right: 3; margin-top: 0" align="center"><font size="1" color="#0000FF">
            Print articles newly available online</font><!--mstheme--></font><table border="1" cellpadding="0" cellspacing="0" style="border-collapse: collapse" bordercolor="#111111" width="100%" id="AutoNumber1" bgcolor="#FFFFCC" bordercolordark="#006666" bordercolorlight="#99CCCC">
              <tr>
                <td width="100%" bordercolor="#808000"><!--mstheme--><font face="Arial, Arial, Helvetica">
                <p style="margin: 3"><font size="1" color="#0000FF">
                <a href="../publications/mill20.htm"><b><i>
                <font color="#0000FF">Sutter's Mill</font></i></b><font color="#0000FF"> 
                column, &quot;Toward a Standard C++ Library, Part 1&quot;</font></a></font><!--mstheme--></font></td>
              </tr>
              <tr>
                <td width="100%" bordercolor="#808000" bgcolor="#FFFFCC"><!--mstheme--><font face="Arial, Arial, Helvetica">
                <p style="margin: 3"><font size="1" color="#0000FF">
                <a href="../publications/mxc++-item-4.htm">
                <font color="#0000FF">Excerpt from MXC++, &quot;Extensible Templates: 
                Via Inheritance or Traits?&quot;</font></a></font><!--mstheme--></font></td>
              </tr>
              <tr>
                <td width="100%" bordercolor="#808000"><!--mstheme--><font face="Arial, Arial, Helvetica">
                <p style="margin: 3"><font size="1" color="#0000FF">
                <a href="../publications/mcd_review.htm"><font color="#0000FF">
                Book Review: Modern C++ Design</font></a></font><!--mstheme--></font></td>
              </tr>
              <tr>
                <td width="100%" bordercolor="#808000"><!--mstheme--><font face="Arial, Arial, Helvetica">
                <p style="margin: 3"><font size="1" color="#0000FF">
                <a href="../publications/mill21.htm"><b><i>
                <font color="#0000FF">Sutter's Mill</font></i></b><font color="#0000FF"> 
                column, &quot;Toward a Standard C++ Library, Part 2: Namespaceops and 
                Library Versioning&quot;</font></a></font><!--mstheme--></font></td>
              </tr>
            </table><!--mstheme--><font face="Arial, Arial, Helvetica">
          <!--mstheme--></font></td>
        </tr>
        <tr>
          <td align="left" bgcolor="#FFFF99" bordercolor="#CCCCCC"><!--mstheme--><font face="Arial, Arial, Helvetica">
            <p style="margin: 0 3"><font size="1" color="#0000FF"><b><i>Sutter's 
            Mill</i></b> column,
            &quot;A Pragmatic Look at Exception Specifications&quot;<br>
            </font><font size="1" color="#000080">The usefulness, or lack 
            thereof, of exception specifications, and how results can vary 
            across real-world compilers</font><!--mstheme--></font></td>
        </tr>
        <tr>
          <td align="left" bgcolor="#FFFF99" bordercolor="#CCCCCC"><!--mstheme--><font face="Arial, Arial, Helvetica">
            <p style="margin: 0 3">
            <a target="_blank" href="http://www.cuj.com/experts/2007/hyslop.htm"><font size="1" color="#0000FF"><i><b>Conversations</b></i> column,
            &quot;Getting to the Point&quot;</font></a><font color="#0000FF" size="1"><br>
            </font><font size="1" color="#000080">The Boost library has five 
            smart pointers that provide a rich array [sic] of useful behaviors.</font><!--mstheme--></font></td>
        </tr>
        <tr>
          <td align="center" bgcolor="#CCCCCC" bordercolor="#CCCCCC" rowspan="2"><!--mstheme--><font face="Arial, Arial, Helvetica"><font color="#0000FF" size="1">A<br>
            U<br>
          G<br>
          U<br>
          S<br>
          T</font><!--mstheme--></font></td>
          <td align="left" bgcolor="#FFFF99" bordercolor="#CCCCCC"><!--mstheme--><font face="Arial, Arial, Helvetica">
            <p style="margin:0 3; ">
            <a target="_blank" href="http://www.cuj.com/experts/2008/sutter.htm"><i><b><font size="1" color="#0000FF">The New C++</font></b></i> <font size="1" color="#0000FF">
            column, &quot;Smart(er) Pointers&quot;</font></a><font size="1" color="#000080"><br>
            A closer look at one of the proposed new standard C++ library 
            features -- smart pointers, particularly those in Boost and Loki, 
            and a sneak peek at the usefulness of the proposed typedef templates</font><!--mstheme--></font></td>
        </tr>
        <tr>
          <td align="left" bgcolor="#FFFF99" bordercolor="#CCCCCC"><!--mstheme--><font face="Arial, Arial, Helvetica">
          <p style="margin:0 3; ">
          <a target="_blank" href="http://www.cuj.com/experts/2008/hyslop.htm"><font size="1" color="#0000FF"><i><b>Conversations</b></i> column,
            &quot;A Midsummer Night's Madness&quot;</font></a><font color="#0000FF" size="1"><br>
            </font><font size="1" color="#000080">A brew that mixes pointers, 
          typedefs, and const</font><!--mstheme--></font></td>
        </tr>
        <tr>
          <td align="center" bgcolor="#CCCCCC" bordercolor="#CCCCCC" rowspan="3"><!--mstheme--><font face="Arial, Arial, Helvetica">
          <p style="margin-top: 0; margin-bottom: 0">
          <font size="1" color="#0000FF">S<br>
          E<br>
          P<br>
          T<br>
          E<br>
          M<br>
          B<br>
          E<br>
          R</font><!--mstheme--></font></td>
        </tr>
        <tr>
          <td align="left" bgcolor="#FFFF99" bordercolor="#CCCCCC"><!--mstheme--><font face="Arial, Arial, Helvetica">
            <p style="margin: 0 3">
            <font size="1" color="#0000FF">&quot;Standard C++ Meets Managed C++&quot;<br>
            </font><font size="1" color="#000080">A survey of the main (in)compatibilities 
            between Standard C++ and Microsoft’s managed extensions for C++, and 
            how the two could converge</font><!--mstheme--></font></td>
        </tr>
        <tr>
          <td align="left" bgcolor="#FFFF99" bordercolor="#CCCCCC"><!--mstheme--><font face="Arial, Arial, Helvetica">
            <p style="margin: 0 3"><font size="1" color="#0000FF"><b><i>Sutter's 
            Mill</i></b> column,
            &quot;Export Restrictions, Part 1&quot;<br>
            </font><font size="1" color="#000080">The scoop on export -- what 
            some people think it does, what it actually does, and why it’s the 
            most widely-ignored feature in the C++ standard</font><!--mstheme--></font></td>
        </tr>
      </table><!--mstheme--><font face="Arial, Arial, Helvetica"><!--mstheme--></font></td>
  </tr>
</table><!--mstheme--><font face="Arial, Arial, Helvetica">
<p style="margin-top: 0; margin-bottom: 0">
<img border="0" src="../images/140.gif" width="140" height="1"></p>

<!--mstheme--></font></td><td valign="top" width="24"></td><!--msnavigation--><td valign="top"><!--mstheme--><font face="Arial, Arial, Helvetica">
<!--mstheme--></font><table border="1" cellpadding="6" cellspacing="0" width="100%" bgcolor="#CCCCFF" bordercolordark="#006666" bordercolorlight="#99CCCC">
  <tr>
    <td width="100%"><!--mstheme--><font face="Arial, Arial, Helvetica">
      <p align="center">This is the original GotW problem and solution
      substantially as posted to Usenet. See the book <i><a href="../publications/mxc++.htm"><b>More
      Exceptional C++</b></a></i> (Addison-Wesley, 2002) for the most current
      solution to this GotW issue. The solutions in the book have been revised
      and expanded since their initial appearance in GotW. The book versions
      also incorporate corrections, new material, and conformance to the final
      ANSI/ISO C++ standard.</p>
    <!--mstheme--></font></td>
  </tr>
</table><!--mstheme--><font face="Arial, Arial, Helvetica">
      <h2><!--mstheme--><font face="Verdana, Arial, Helvetica" color="#006666">Migrating to Namespaces&nbsp;<font size="3"><br>
      Difficulty: 4 / 10</font><!--mstheme--></font></h2>
<p><i>Standard C++ includes support for namespaces and name visibility
control with using declarations and directives. What's the best way to use these
powerful facilities, and what's the most effective way to initially migrate your
existing C++ code to a namespace-aware compiler and library?</i></p>
<p align="center"><img border="0" src="../images/h-line.gif" width="248" height="2"></p>

<h3><!--mstheme--><font face="Verdana, Arial, Helvetica" color="#006666">Problem<!--mstheme--></font></h3>

<h4><!--mstheme--><font face="Verdana, Arial, Helvetica" color="#006666">JG Question<!--mstheme--></font></h4>
<p><b><font size="4">1.</font></b>   What are using-declarations and
using-directives, and how are they used? Give examples.</p>
<p>Bonus: What does MLOC stand for?</p>
<h4><!--mstheme--><font face="Verdana, Arial, Helvetica" color="#006666">Guru Question<!--mstheme--></font></h4>
<p><b><font size="4">2.</font></b>   You are working on a MLOC project with over
1,000 .h and .cpp files. The project team is just upgrading to the latest
version of your compiler, which finally both supports namespaces and puts all of
the standard library features into namespace std. Unfortunately, this
conformance boon has the side effect of breaking your current build. As always,
there is never enough time allocated to do a detailed job; you would like to
analyze every source file and write exactly the needed using-declarations in
each one, but that's infeasible at this time.</p>
<p>What is the most effective way to deal with this problem and safely migrate
your code base to the new (and more standard) environment? Discuss alternatives,
and prefer the quickest approach that gets the job done without compromising
future safety and usability. How can you best defer unnecessary (for now)
migration work to the future without increasing the overall migration workload
later?</p>
<p align="center"><img border="0" src="../images/h-line.gif" width="248" height="2"></p>
<h3><!--mstheme--><font face="Verdana, Arial, Helvetica" color="#006666"><a name="Solution"></a>Solution<!--mstheme--></font></h3>

<p><font color="#999933"><b><font size="4">1.</font></b>   What are
using-declarations and using-directives, and how are they used? Give examples.</font></p>

<h4><!--mstheme--><font face="Verdana, Arial, Helvetica" color="#006666">Using Declarations<!--mstheme--></font></h4>
<p>A using declaration creates a local synonym for a specific name actually
declared in another namespace. For the purposes of overloading and name
resolution, a using declaration works just like any declaration.</p>
<!--mstheme--></font><pre>    //  Example 1a
    //
    namespace A
    {
      int f( int );
      int i;
    }</pre><!--mstheme--><font face="Arial, Arial, Helvetica"><!--mstheme--></font><pre>    using A::f;
    int f( int );</pre><!--mstheme--><font face="Arial, Arial, Helvetica"><!--mstheme--></font><pre>    int main()
    {
      f( 1 );     // ambiguous: A::f() or ::f()?</pre><!--mstheme--><font face="Arial, Arial, Helvetica"><!--mstheme--></font><pre>      int i;
      using A::i; // error, double declaration (just as
                  //  writing &quot;int i;&quot; again would be)
    }</pre><!--mstheme--><font face="Arial, Arial, Helvetica">

<p>A using declaration only brings in names whose declarations have already been
seen. For example:</p>

<!--mstheme--></font><pre>    //  Example 1b
    //
    namespace A
    {
      class X {};
      int Y();
      int f( double );
    }</pre><!--mstheme--><font face="Arial, Arial, Helvetica"><!--mstheme--></font><pre>    using A::X;
    using A::Y; // only function A::Y(), not class A::Y
    using A::f; // only A::f(double), not A::f(int)</pre><!--mstheme--><font face="Arial, Arial, Helvetica"><!--mstheme--></font><pre>    namespace A
    {
      class Y {};
      int f( int );
    }</pre><!--mstheme--><font face="Arial, Arial, Helvetica"><!--mstheme--></font><pre>    int main()
    {
      X x;      // OK, X is a synonym for A::X
      Y y;      // error, A::Y not visible because the
                //  using declaration preceded the
                //  actual declaration that's wanted</pre><!--mstheme--><font face="Arial, Arial, Helvetica"><!--mstheme--></font><pre>      f( 1 );   // oops: this uses a silent implicit
                //  conversion and calls A::f(double),
                //  NOT A::f(int), because only the
                //  first A::f() declaration had been
                //  seen at the point of the using
                //  declaration for the name A::f
    }</pre><!--mstheme--><font face="Arial, Arial, Helvetica">
<h4><!--mstheme--><font face="Verdana, Arial, Helvetica" color="#006666">Using Directives<!--mstheme--></font></h4>
<p>A using directive allows all names in another namespace to be used in the
scope of the using directive. Unlike a using declaration, a using directive
brings in names declared after the using directive. For example:</p>
<!--mstheme--></font><pre>    //  Example 1c
    //
    namespace A
    {
      class X {};
      int f( double );
    }</pre><!--mstheme--><font face="Arial, Arial, Helvetica"><!--mstheme--></font><pre>    using namespace A;</pre><!--mstheme--><font face="Arial, Arial, Helvetica"><!--mstheme--></font><pre>    namespace A
    {
      class Y {};
      int f( int );
    }</pre><!--mstheme--><font face="Arial, Arial, Helvetica"><!--mstheme--></font><pre>    int main()
    {
      X x;      // OK, X is a synonym for A::X
      Y y;      // OK, Y is a synonym for A::Y</pre><!--mstheme--><font face="Arial, Arial, Helvetica"><!--mstheme--></font><pre>      f( 1 );   // OK, calls A::f(int)
    }</pre><!--mstheme--><font face="Arial, Arial, Helvetica">
<p><font color="#999933">Bonus: What does MLOC stand for?</font></p>
<p>MLOC stands for millions of lines of code. Typically, the measurement counts
only noncomment, nonblank lines.</p>
<h4><!--mstheme--><font face="Verdana, Arial, Helvetica" color="#006666">Migrating To Namespaces, Safely and Effectively<!--mstheme--></font></h4>
<p>Background: The situation described in Question #2 is pretty typical for
projects whose compilers are supporting namespaces for the first time.</p>
<p>Note that in such a situation by definition there can't already be name
conflicts in the existing project (including both custom code and libraries)
because namespaces didn't yet exist, so the main problem that needs a solution
is that now the standard library is in namespace std and so unqualified uses of
&quot;std::&quot; names in the project code will now fail to compile.</p>
<p><font color="#999933"><b><font size="4">2.</font></b>   You are working on a
MLOC project with over 1,000 .h and .cpp files. The project team is just
upgrading to the latest version of your compiler, which finally both supports
namespaces and puts all of the standard library features into namespace std.
Unfortunately, this conformance boon has the side effect of breaking your
current build.</font></p>
<p>First, let's go on a short tangent to analyze the best long-term solution.
Then we'll know better what to look for in a good short-term solution that won't
end up being just thrown away and reworked when we get to the long-term
solution.</p>
<h4><!--mstheme--><font face="Verdana, Arial, Helvetica" color="#006666">Characteristics of a Good Long-Term Solution<!--mstheme--></font></h4>

<p><font color="#999933">As always, there is never enough time allocated to do a
detailed job; you would like to analyze every source file and write exactly the
needed using-declarations in each one, but that's infeasible at this time.</font></p>

<p>In short, a good long-term solution for namespace usage should follow at
least these rules:</p>
<p>1. Using directives should be avoided entirely, especially in header files.<b><sup><a href="#1">[1]</a></sup></b></p>
<p>The reason for Guideline #1 is that using directives cause wanton namespace
pollution by bringing in potentially huge numbers of names, many (usually the
vast majority) of which are unnecessary. The presence of the unnecessary names
greatly increases the possibility of unintended name conflicts -- not just in
the header, but in every module that #includes the header.</p>
<p>2. Namespace using declarations should never appear in header files.</p>
<p>The reason for Guideline #2 is less obvious.</p>
<p>Most authors recommend that using declarations never appear AT FILE SCOPE in
shared header files. That's good advice, as far as it goes, because at file
scope a using declaration causes the same kind of namespace pollution as using
directives, only less of it.</p>
<p>Unfortunately, in my opinion the above &quot;usual advice&quot; doesn't go
far enough. Here is why you should never write using declarations in header
files at all, not even in a namespace scope: The meaning of the using
declaration may change depending on what other headers happen to be #included
before it in any given module. (I'll come back to this point again when I get to
Example 2c later on.)</p>
<p>Think about what this means. To illustrate, consider the following example
module and two good long-term approaches to migrating the module to namespaces:</p>
<!--mstheme--></font><pre>    //  Example 2a: Original namespace-free code
    //</pre><!--mstheme--><font face="Arial, Arial, Helvetica"><!--mstheme--></font><pre>    //--- file x.h ---
    //
    #include &quot;y.h&quot;  // declares Y
    #include &lt;deque&gt;
    #include &lt;iosfwd&gt;</pre><!--mstheme--><font face="Arial, Arial, Helvetica"><!--mstheme--></font><pre>    ostream&amp; operator&lt;&lt;( ostream&amp;, const Y&amp; );
    int f( const deque&lt;int&gt;&amp; );</pre><!--mstheme--><font face="Arial, Arial, Helvetica"><!--mstheme--></font><pre>    //--- file x.cpp ---
    //
    #include &quot;x.h&quot;
    #include &quot;z.h&quot;  // declares Z
    #include &lt;ostream&gt;</pre><!--mstheme--><font face="Arial, Arial, Helvetica"><!--mstheme--></font><pre>    ostream&amp; operator&lt;&lt;( ostream&amp; o, const Y&amp; y )
    {
      // ... uses Z in the implementation ...
      return o;
    }</pre><!--mstheme--><font face="Arial, Arial, Helvetica"><!--mstheme--></font><pre>    int f( const deque&lt;int&gt;&amp; d )
    {
      // ...
    }</pre><!--mstheme--><font face="Arial, Arial, Helvetica">
<p>How can we best migrate the above code to a compiler that respects namespaces
and puts standard names in namespace std? Before reading on, please stop for a
moment and think about what alternatives you might consider. Which ones are
good? Which ones aren't? Why?</p>
<p align="center">* * *</p>
<p>There are several ways you might approach this. I'll describe two common
strategies, only one of which is good form.</p>
<h4><!--mstheme--><font face="Verdana, Arial, Helvetica" color="#006666">A Good Long-Term Solution<!--mstheme--></font></h4>
<p>A good long-term solution is to explicitly qualify every standard name
wherever it is mentioned in x.h, and to write just the using declarations that
are needed inside each source (.cpp) file for convenience, since those names are
likely to be widely used in the source file:</p>
<!--mstheme--></font><pre>    //  Example 2b: Good long-term solution
    //</pre><!--mstheme--><font face="Arial, Arial, Helvetica"><!--mstheme--></font><pre>    //--- file x.h ---
    //
    #include &quot;y.h&quot;  // declares Y
    #include &lt;deque&gt;
    #include &lt;iosfwd&gt;</pre><!--mstheme--><font face="Arial, Arial, Helvetica"><!--mstheme--></font><pre>    std::ostream&amp; operator&lt;&lt;( std::ostream&amp;, const Y&amp; );
    int f( const std::deque&lt;int&gt;&amp; );</pre><!--mstheme--><font face="Arial, Arial, Helvetica"><!--mstheme--></font><pre>    //--- file x.cpp ---
    //
    #include &quot;x.h&quot;
    #include &quot;z.h&quot;  // declares Z
    #include &lt;ostream&gt;</pre><!--mstheme--><font face="Arial, Arial, Helvetica"><!--mstheme--></font><pre>    using std::deque;   // using declarations appear
    using std::ostream; //  AFTER all #includes</pre><!--mstheme--><font face="Arial, Arial, Helvetica"><!--mstheme--></font><pre>    ostream&amp; operator&lt;&lt;( ostream&amp; o, const Y&amp; y )
    {
      // ... uses Z in the implementation ...
      return o;
    }</pre><!--mstheme--><font face="Arial, Arial, Helvetica"><!--mstheme--></font><pre>    int f( const deque&lt;int&gt;&amp; d )
    {
      // ...
    }</pre><!--mstheme--><font face="Arial, Arial, Helvetica">
<p>Note that the using declarations inside x.cpp had better come after all
#include directives, otherwise they may introduce name conflicts into other
header files depending on #include orders.</p>
<p>[An alternative good long-term solution would be to do the above but eschew
the using declarations entirely and explicitly qualify each standard name, even
inside the .cpp file. I don't recommend doing that, because it's a lot of extra
work that doesn't deliver any real advantage in a typical situation like this.]</p>
<h4><!--mstheme--><font face="Verdana, Arial, Helvetica" color="#006666">A Not-So-Good Long-Term Solution<!--mstheme--></font></h4>
<p>In contrast, a bad long-term solution would be to put all of the project's
code into its own namespace (which is not objectionable in itself, but isn't as
useful as you might think) and write the using declarations or directives in the
headers (which opens the door for potential problems). The reason some people
have proposed this method is that it requires less typing than some other
namespace-migration methods:</p>
<!--mstheme--></font><pre>    //  Example 2c: Bad long-term solution (or, Why to
    //              avoid using declarations in
    //              headers, even not at file scope)
    //</pre><!--mstheme--><font face="Arial, Arial, Helvetica"><!--mstheme--></font><pre>    //--- file x.h ---
    //
    #include &quot;y.h&quot;  // declares MyProject::Y and adds
                    //  using declarations/directives
                    //  in namespace MyProject
    #include &lt;deque&gt;
    #include &lt;iosfwd&gt;</pre><!--mstheme--><font face="Arial, Arial, Helvetica"><!--mstheme--></font><pre>    namespace MyProject
    {
      using std::deque;
      using std::ostream;
      // or, &quot;using namespace std;&quot;</pre><!--mstheme--><font face="Arial, Arial, Helvetica"><!--mstheme--></font><pre>      ostream&amp; operator&lt;&lt;( ostream&amp;, const Y&amp; );
      int f( const deque&lt;int&gt;&amp; );
    }</pre><!--mstheme--><font face="Arial, Arial, Helvetica"><!--mstheme--></font><pre>    //--- file x.cpp ---
    //
    #include &quot;x.h&quot;
    #include &quot;z.h&quot;  // declares MyProject::Z and adds
                    //  using declarations/directives
                    //  in namespace MyProject
      // error: potential future name ambiguities in
      //        z.h's declarations, depending on what
      //        using declarations exist in headers
      //        that happen to be #included before z.h
      //        in any given module (in this case,
      //        x.h or y.h may cause potential changes
      //        in meaning)
    #include &lt;ostream&gt;</pre><!--mstheme--><font face="Arial, Arial, Helvetica"><!--mstheme--></font><pre>    namespace MyProject
    {
      ostream&amp; operator&lt;&lt;( ostream&amp; o, const Y&amp; y )
      {
        // ... uses Z in the implementation ...
        return o;
      }</pre><!--mstheme--><font face="Arial, Arial, Helvetica"><!--mstheme--></font><pre>      int f( const deque&lt;int&gt;&amp; d )
      {
        // ...
      }
    }</pre><!--mstheme--><font face="Arial, Arial, Helvetica">
<p>Note the error. The reason, as stated, is that the meaning of a using
declaration in a header can change -- even when the using declaration is inside
a namespace, and not at file scope -- depending on what else a client module may
happen to #include before it. It's ALWAYS bad form to write any kind of code
that can silently change meaning depending on the order in which headers are
#included. (It's also bad form to write header code that requires the user to
#include other headers manually ahead of it; headers should always be
self-contained and work correctly even if #included alone.)</p>
<h4><!--mstheme--><font face="Verdana, Arial, Helvetica" color="#006666">An Effective Short-Term Solution<!--mstheme--></font></h4>
<p>The reason why I've spent time explaining desirable long-term solutions is so
that, when we pick a simpler short-term solution, we pick one that won't
compromise a good long-term solution:</p>
<p><font color="#999933">What is the most effective way to deal with this
problem and safely migrate your code base to the new (and more standard)
environment? Discuss alternatives, and prefer the quickest approach that gets
the job done without compromising future safety and usability. How can you best
defer unnecessary (for now) migration work to the future without increasing the
overall migration workload later?</font></p>
<p>Adding using declarations or directives in the headers would be the least
work, but it's work that would have to be undone when we implement the correct
long-term solution. We've already seen enough reasons not to go down that road.
Given that we mustn't add using declarations or directives in headers, our only
alternative is to add &quot;std::&quot; in the right places in the headers.</p>
<p>We can, however, get away with writing a using directive in each
implementation file, which avoids/defers the tedious work of figuring out the
(possibly lengthy) correct set of using declarations that will eventually go
into each implementation file. Note that this doesn't compromise -- or change
the meaning -- of any other code in any other modules, including the headers we
#include, as long as we're careful to write the using directive after all of the
#include statements. For convenience, and for a good reason that will become
clearer in a moment, I'll put the using directive into a separate header to be
#included after all others.</p>
<p>Finally, we can defer the work of moving to the new &lt;cheader&gt; C header
style too, which also defers all of the associated namespace issues.</p>
<p>Here's the result:</p>
<!--mstheme--></font><pre>    //  Example 2d: Good short-term solution is to:
    //              - in headers, write std:: as needed
    //              - in .cpp files, #include
    //                &quot;myproject_last.h&quot; after all
    //                other headers
    //</pre><!--mstheme--><font face="Arial, Arial, Helvetica"><!--mstheme--></font><pre>    //--- file x.h ---
    //
    #include &quot;y.h&quot;  // declares Y
    #include &lt;deque&gt;
    #include &lt;iosfwd&gt;</pre><!--mstheme--><font face="Arial, Arial, Helvetica"><!--mstheme--></font><pre>    std::ostream&amp; operator&lt;&lt;( std::ostream&amp;, const Y&amp; );
    int f( const std::deque&lt;int&gt;&amp; );</pre><!--mstheme--><font face="Arial, Arial, Helvetica"><!--mstheme--></font><pre>    //--- file x.cpp ---
    //
    #include &quot;x.h&quot;
    #include &quot;z.h&quot;  // declares Z
    #include &lt;ostream&gt;
    #include &quot;myproject_last.h&quot;
                    // AFTER all other #includes</pre><!--mstheme--><font face="Arial, Arial, Helvetica"><!--mstheme--></font><pre>    ostream&amp; operator&lt;&lt;( ostream&amp; o, const Y&amp; y )
    {
      // ... uses Z in the implementation ...
      return o;
    }</pre><!--mstheme--><font face="Arial, Arial, Helvetica"><!--mstheme--></font><pre>    int f( const deque&lt;int&gt;&amp; d )
    {
      // ...
    }</pre><!--mstheme--><font face="Arial, Arial, Helvetica"><!--mstheme--></font><pre>    //--- common file myproject_last.h ---
    //
    using namespace std;</pre><!--mstheme--><font face="Arial, Arial, Helvetica">
<p>This does not compromise the long-term solution in that it doesn't do
anything that will need to be &quot;undone&quot; for the long-term solution. At
the same time, it's simpler and requires fewer code changes than the full
long-term solution would.</p>
<h4><!--mstheme--><font face="Verdana, Arial, Helvetica" color="#006666">Migrating To the Long-Term Solution<!--mstheme--></font></h4>
<p>In the future, this allows a simple migration to the full long-term solution.
Simply follow these steps:</p>
<p>- in each header: change lines that #include C headers to the new
&lt;cheader&gt; style; e.g., change &quot;#include &lt;stdio.h&gt;&quot; to
&quot;#include &lt;cstdio&gt;&quot;</p>
<p>- in myproject_last.h: comment out the using directive</p>
<p>- rebuild; in each implementation file, see what breaks and add the correct
using declarations (after all #includes)</p>
<p>If you follow this advice, then even with looming project deadlines you'll be
able to quickly -- and effectively -- migrate to a namespace-aware compiler and
library, all without compromising your long-term solution.</p>

<p>&nbsp;</p>

<h4><!--mstheme--><font face="Verdana, Arial, Helvetica" color="#006666">Notes<!--mstheme--></font></h4>
<p><a name="1"></a>1. Unless of course the header is only #included by one
module, but this case is rare enough that I didn't want to cause possible
confusion by writing &quot;...in shared header files,&quot; lest someone think
this advice applies only to headers shared between projects. It applies to all
headers that are #included by more than one module.</p>
<!--mstheme--></font><!--msnavigation--></td></tr><!--msnavigation--></table><!--msnavigation--><table border="0" cellpadding="0" cellspacing="0" width="100%"><tr><td><!--mstheme--><font face="Arial, Arial, Helvetica"><h4 align="right"><!--mstheme--><font face="Verdana, Arial, Helvetica" color="#006666"><a href="../copyright.htm"><font size="2">Copyright ©
2002 Herb Sutter</font></a><!--mstheme--></font></h4>

<!--mstheme--></font></td></tr><!--msnavigation--></table></body>
</html>

